<template>
		<div
			class="row csc-cf-destination-cont"
			:class="removed"
		>
			<div class="col col-xs-12 col-md-4 text-right">
				{{ $t('pages.newCallForward.destinationTimeoutLabel') }}
				<span class='csc-cf-timeout'>
					{{this.destinationTimeout}}
					<q-popover
						ref="timeoutForm"
						self="top left"
						class="csc-cf-timeout-form"
						@close="saveTimeout()"
					>
						<q-slider
							v-model="destinationTimeout"
							label
							label-always
							:step="5"
							:min="0"
							:max="300"
							snap
						/>
					</q-popover>
				</span>
				{{ $t('pages.newCallForward.destinationNumberLabel') }}
			</div>
			<div class="col text-left col-xs-12 col-md-2 csc-cf-dest-number-cont">

				<div class='csc-cf-destination'>
					{{ !this.destinationNumber || this.destinationNumber.length < 2
							? $t('pages.newCallForward.destinationLabel')
							: this.destinationNumber}}
					<q-popover
						ref="numberForm"
						anchor="top right"
						class="csc-cf-number-form"
						@open="showNumberForm()"
					>
						<csc-new-call-forward-add-destination-form
							ref="addDestinationForm"
							:index="this.destinationIndex"
							:destination="this.destinationNumber"
						/>
					</q-popover>
				</div>
			</div>
			<div class="col col-xs-12 col-md-5 csc-cf-destination-actions">
				<q-icon
					name="delete"
					color="negative"
					size="24px"
					@click="showConfirmDialog"
				/>
				<csc-confirm-dialog
					ref="confirmDialog"
					title-icon="delete"
					:title="$t('pages.newCallForward.cancelDialogTitle', {groupName: this.groupName})"
					:message="$t('pages.newCallForward.cancelDialogText', {groupName: this.groupName, destination: this.destination.simple_destination})"
					@confirm="deleteDestination"
				/>
			</div>
	</div>

</template>

<script>
	import {
		QIcon,
		QBtn,
		QPopover,
		QSlider,
		QList,
		QItem,
		QItemMain
	} from 'quasar-framework'
	import CscConfirmDialog from "../../CscConfirmationDialog";
	import CscNewCallForwardAddDestinationForm from './CscNewCallForwardAddDestinationForm'
    export default {
        name: 'csc-new-call-forward-destination',
        components: {
			QIcon,
			QBtn,
			QPopover,
			QSlider,
			QList,
			QItem,
			QItemMain,
			CscConfirmDialog,
			CscNewCallForwardAddDestinationForm
		},
        props: [
			'groupId',
			'groupName',
            'destination',
			'index'
        ],
        mounted(){
			this.updateValues(this.destination)
		},
		data(){
			return {
				destinationTimeout: 0,
				destinationNumber: null,
				destinationIndex: null,
				isRemoved: false
			}
		},
		computed: {
			removed(){
				return this.isRemoved ? "csc-cf-removed-destination" : "";
			}
		},
        methods: {
			updateValues(destination){
				this.destinationTimeout = destination.timeout;
				this.destinationNumber = destination.simple_destination;
				this.destinationIndex = this.index;
			},
			showNumberForm(){
				this.$refs.addDestinationForm.add();
			},
			async saveTimeout(){
				this.$store.dispatch('newCallForward/editTimeout', {
					index: this.destinationIndex,
					timeout: this.destinationTimeout,
					forwardGroupId: this.groupId
				});
			},
			showConfirmDialog(){
				this.$refs.confirmDialog.open();
			},
			deleteDestination(){
				this.isRemoved = true;
				setTimeout(async ()=>{
					await this.$store.dispatch('newCallForward/removeDestination', {
						destination: this.destination,
						forwardGroupId: this.groupId
					});
					await this.$store.dispatch('newCallForward/loadForwardGroups');
				}, 1200);
			}
		}
    }
</script>

<style lang="stylus" rel="stylesheet/stylus">
    @import '../../../themes/app.common.styl'
	.csc-cf-destination-cont
		width 100%
		padding 5px
	.csc-cf-timeout,
	.csc-cf-destination
		width 100px
		white-space nowrap
		overflow hidden
		text-overflow ellipsis
		color $primary
		cursor pointer
	.csc-cf-timeout-form,
	.csc-cf-number-form
		min-width 120px
		padding 0 20px 0 20px
	.csc-cf-dest-number-cont
		padding-left 30px
	.csc-cf-destination-actions
		text-align left
		cursor pointer
	.csc-cf-removed-destination
		visibility hidden
		opacity 0
		transition visibility 0s 1s, opacity 1s linear
</style>
