<template>
    <q-item :class="itemClasses">
        <q-item-side
            v-if="!expanded"
        >
            <q-icon
                size="24px"
                name="person"
                color="white"
            />
        </q-item-side>
        <q-item-main>
            <q-item-tile
                v-if="!expanded"
                class="csc-item-title"
                label
            >
                {{ seatName(seat.id) }}
            </q-item-tile>
            <q-item-tile
                v-if="!expanded"
                class="csc-item-subtitle"
                sublabel
            >
                <span class="csc-item-label">{{ $t('pbxConfig.extension') }}:</span>
                <span class="csc-item-value">{{ seat.pbx_extension }}</span>
            </q-item-tile>
            <q-item-tile
                v-if="!expanded"
                class="csc-item-subtitle"
                sublabel
            >
                <div
                    v-if="!hasGroups"
                    class="csc-form-info"
                >
                    <q-icon name="info" color="info" size="24px"/>
                    <span class="csc-info-text">{{ $t('pbxConfig.noGroupAssigned') }}</span>
                </div>
                <div
                    class="csc-item-field"
                    v-if="hasGroups"
                >
                    <span
                        class="csc-item-label"
                    >
                        {{ $t('pbxConfig.groups') }}:
                    </span>
                    <span
                        class="csc-item-value"
                        v-for="group in seat.groups"
                    >
                        {{ groupName(group.id) }}
                    </span>
                </div>
            </q-item-tile>
            <q-item-tile
                class="csc-list-item-main"
                v-if="expanded"
            >
                <q-field :label="$t('pbxConfig.name')">
                    <q-input
                        dark
                        v-model="changes.name"
                        :after="nameButtons"
                        @keyup.enter="saveName"
                    />
                </q-field>
                <q-field :label="$t('pbxConfig.extension')">
                    <q-input
                        dark
                        v-model="changes.extension"
                        :after="extensionButtons"
                        @keyup.enter="saveExtension"
                    />
                </q-field>
                <q-field :label="$t('pbxConfig.primaryNumber')">
                    <q-input
                        dark
                        v-model="primaryNumber"
                        readonly
                        disable
                    />
                </q-field>
                <q-field :label="$t('pbxConfig.aliasNumbers')">
                    <q-select
                        dark
                        ref="aliasNumbers"
                        v-model="changes.aliasNumbers"
                        :options="aliasNumberOptions"
                        multiple
                        chips
                        clearable
                        :after="aliasNumberButtons"
                    />
                </q-field>
                <q-field :label="$t('pbxConfig.groups')">
                    <q-select
                        dark
                        v-model="changes.groups"
                        :options="groupOptions"
                        multiple
                        chips
                        clearable
                        :after="groupButtons"
                    />
                </q-field>
                <q-field :label="$t('pbxConfig.soundSet')">
                    <q-select
                        dark
                        v-model="changes.soundSet"
                        :disable="!defaultSoundSet"
                        :readonly="loading"
                        :options="soundSetOptions"
                        :after="soundSetButtons"
                    />
                    <q-tooltip
                        v-if="!defaultSoundSet"
                    >
                        {{ $t('pbxConfig.defaultNotSet') }}
                    </q-tooltip>
                </q-field>
            </q-item-tile>
        </q-item-main>
        <q-item-side
            right
            class="csc-list-actions-pinned"
        >
            <q-item-tile>
                <q-btn
                    v-if="expanded"
                    icon="more_vert"
                    color="primary"
                    flat
                >
                    <q-popover
                        ref="morePopover"
                        anchor="bottom right"
                        self="top right"
                    >
                        <q-list
                            class="csc-item-buttons-menu"
                            no-border
                        >
                            <q-item
                                v-if="seat.cloud_pbx_callqueue"
                                link
                                @click="$router.push(callQueueRouteWithId)"
                            >
                                <q-item-side
                                    icon="queue"
                                    color="primary"
                                />
                                <q-item-main
                                    :label="$t('pbxConfig.callQueue')"
                                />
                            </q-item>
                            <q-item
                                link
                                @click="remove"
                            >
                                <q-item-side
                                    icon="delete"
                                    color="negative"
                                />
                                <q-item-main
                                    :label="$t('buttons.remove')"
                                />
                            </q-item>
                        </q-list>
                    </q-popover>
                </q-btn>
                <q-btn
                    :icon="titleIcon"
                    :big="isMobile"
                    color="primary"
                    flat
                    @click="toggleMain()"
                />
            </q-item-tile>
        </q-item-side>
        <csc-object-spinner
            v-if="loading"
            :loading="loading"
        />
    </q-item>
</template>

<script>
    import _ from 'lodash';
    import numberFilter from '../../../filters/number'
    import {
        QField,
        QInput,
        QIcon,
        QSelect,
        QChip,
        QBtn,
        QInnerLoading,
        QSpinnerDots,
        Platform,
        QItem,
        QItemSide,
        QItemMain,
        QItemTile,
        QAlert,
        QList,
        QPopover,
        QTooltip
    } from 'quasar-framework'
    import CscObjectSpinner from "../../CscObjectSpinner";
    export default {
        name: 'csc-pbx-seat',
        props: [
            'seat',
            'aliasNumberOptions',
            'groupOptions',
            'loading',
            'callQueue',
            'seatName',
            'groupName',
            'defaultSoundSet',
            'soundSetOptions',
            'soundSetLabel'
        ],
        data () {
            return {
                expanded: false,
                changes: this.getSeat()
            }
        },
        components: {
            CscObjectSpinner,
            QField,
            QInput,
            QIcon,
            QSelect,
            QChip,
            QBtn,
            QInnerLoading,
            QSpinnerDots,
            QItem,
            QItemSide,
            QItemMain,
            QItemTile,
            QAlert,
            QList,
            QPopover,
            QTooltip
        },
        computed: {
            callQueueRouteWithId() {
                return {
                    path: '/user/pbx-configuration/call-queues',
                    query: { item: this.id }
                };
            },
            itemClasses() {
                let classes = ['csc-list-item', 'csc-pbx-seat'];
                if (this.expanded) {
                    classes.push('csc-item-expanded');
                }
                else {
                    classes.push('csc-item-collapsed');
                }
                return classes;
            },
            entityTitle() {
                return this.seat.display_name ?
                    this.seat.display_name : this.seat.username;
            },
            id() {
                return this.seat.id;
            },
            name() {
                return this.seat.display_name;
            },
            extension() {
                return this.seat.pbx_extension;
            },
            soundSet() {
                return this.seat.contract_sound_set_id;
            },
            primaryNumber() {
                return numberFilter(this.seat.primary_number);
            },
            seatModel() {
                return {
                    id: this.id,
                    name: this.changes.name,
                    extension: this.changes.extension,
                    primaryNumber: this.primaryNumber,
                    aliasNumbers: this.changes.aliasNumbers,
                    groups: this.changes.groups,
                    soundSet: this.soundSetLabel(this.changes.soundSet)
                }
            },
            isLoading() {
                return this.loading;
            },
            titleIcon() {
                if(!this.expanded) {
                    return 'keyboard arrow down';
                }
                else {
                    return 'keyboard arrow up';
                }
            },
            isMobile() {
                return Platform.is.mobile;
            },
            nameHasChanges() {
                return this.name !== this.changes.name;
            },
            nameButtons() {
                let buttons = [];
                let self = this;
                if(this.nameHasChanges) {
                    buttons.push({
                            icon: 'check',
                            error: false,
                            handler (event) {
                                event.stopPropagation();
                                self.saveName();
                            }
                        }, {
                            icon: 'clear',
                            error: false,
                            handler (event) {
                                event.stopPropagation();
                                self.resetName();
                            }
                        }
                    );
                }
                return buttons;
            },
            extensionHasChanges() {
                return this.extension + "" !== this.changes.extension + "";
            },
            extensionButtons() {
                let buttons = [];
                let self = this;
                if(this.extensionHasChanges) {
                    buttons.push({
                            icon: 'check',
                            error: false,
                            handler (event) {
                                event.stopPropagation();
                                self.saveExtension();
                            }
                        }, {
                            icon: 'clear',
                            error: false,
                            handler (event) {
                                event.stopPropagation();
                                self.resetExtension();
                            }
                        }
                    );
                }
                return buttons;
            },
            aliasNumbersChanges() {
                return !_.isEqual(this.changes.aliasNumbers.sort(),
                    this.numbersToIds(this.seat.alias_numbers).sort());
            },
            aliasNumberButtons() {
                let buttons = [];
                let self = this;
                if(this.aliasNumbersChanges) {
                    buttons.push({
                            icon: 'check',
                            error: false,
                            handler (event) {
                                event.stopPropagation();
                                self.saveAliasNumbers();
                            }
                        }, {
                            icon: 'clear',
                            error: false,
                            handler (event) {
                                event.stopPropagation();
                                self.resetAliasNumbers();
                            }
                        }
                    );
                }
                return buttons;
            },
            groupChanges() {
                return !_.isEqual(this.changes.groups.sort(),
                    this.groupsToIds(this.seat.groups).sort());
            },
            groupButtons() {
                let buttons = [];
                let self = this;
                if(this.groupChanges) {
                    buttons.push({
                            icon: 'check',
                            error: false,
                            handler (event) {
                                event.stopPropagation();
                                self.saveGroups();
                            }
                        }, {
                            icon: 'clear',
                            error: false,
                            handler (event) {
                                event.stopPropagation();
                                self.resetGroups();
                            }
                        }
                    );
                }
                return buttons;
            },
            hasGroups() {
                return _.isArray(_.get(this.seat, 'groups')) && this.seat.groups.length > 0;
            },
            soundSetChanges() {
                return this.soundSet + "" !== this.changes.soundSet + "";
            },
            soundSetButtons() {
                let buttons = [];
                let self = this;
                if(this.soundSetChanges) {
                    buttons.push({
                            icon: 'check',
                            error: false,
                            handler (event) {
                                event.stopPropagation();
                                self.saveSoundSet();
                            }
                        }, {
                            icon: 'clear',
                            error: false,
                            handler (event) {
                                event.stopPropagation();
                                self.resetSoundSet();
                            }
                        }
                    );
                }
                return buttons;
            }
        },
        methods: {
            toggleMain() {
                this.expanded = !this.expanded;
            },
            remove() {
                this.$emit('remove', this.seatModel);
            },
            resetName() {
                this.changes.name = this.seat.display_name;
            },
            saveName() {
                this.$emit('save-name', this.seatModel);
            },
            resetExtension() {
                this.changes.extension = this.seat.pbx_extension;
            },
            saveExtension() {
                this.$emit('save-extension', this.seatModel);
            },
            numbersToIds(aliasNumbers) {
                let numbers = [];
                if(_.isArray(aliasNumbers)) {
                    aliasNumbers.forEach((number) => {
                        numbers.push(number.number_id);
                    });
                }
                return numbers;
            },
            resetAliasNumbers() {
                this.changes.aliasNumbers = this.numbersToIds(this.seat.alias_numbers);
            },
            saveAliasNumbers() {
                var oldNumbers = this.numbersToIds(this.seat.alias_numbers);
                var numbersToAdd = _.difference(this.changes.aliasNumbers, oldNumbers);
                var numbersToRemove = _.difference(oldNumbers, this.changes.aliasNumbers);
                this.$emit('save-alias-numbers', {
                    item: this.seatModel,
                    add: numbersToAdd,
                    remove: numbersToRemove
                });
            },
            getSeat() {
                return {
                    name: this.seat.display_name,
                    extension: this.seat.pbx_extension,
                    aliasNumbers: this.numbersToIds(this.seat.alias_numbers),
                    groups: this.groupsToIds(this.seat.groups),
                    soundSet: this.seat.contract_sound_set_id
                }
            },
            groupsToIds(groups) {
                let groupIds = [];
                if(_.isArray(groups)) {
                    groups.forEach((group) => {
                        groupIds.push(group.id);
                    });
                }
                return groupIds;
            },
            resetGroups() {
                this.changes.groups = this.groupsToIds(this.seat.groups);
            },
            saveGroups() {
                this.$emit('save-groups', this.seatModel);
            },
            resetSoundSet() {
                this.changes.soundSet = this.seat.contract_sound_set_id;
            },
            saveSoundSet() {
                this.$emit('save-sound-set', this.seatModel);
            }
        },
        watch: {
            seat() {
                this.changes = this.getSeat();
            }
        }
    }
</script>

<style lang="stylus" rel="stylesheet/stylus">
    @import '../../../themes/app.common';
</style>
