<template>
    <div>
        <q-field :error-label="stationNameErrorMessage">
            <q-input
                @input="$v.data.station_name.$touch"
                @blur="$v.data.station_name.$touch"
                :error="$v.data.station_name.$error"
                v-model="data.station_name"
                :disabled="loading"
                :readonly="loading"
                autofocus
                :float-label="$t('pbxConfig.deviceStationName')"
                clearable
            />
        </q-field>
        <q-field :error-label="identifierErrorMessage">
            <q-input
                @input="$v.data.identifier.$touch"
                @blur="$v.data.identifier.$touch"
                :error="$v.data.identifier.$error"
                v-model="data.identifier"
                :disabled="loading"
                :readonly="loading"
                :float-label="$t('pbxConfig.deviceIdentifier')"
                clearable
            />
        </q-field>
        <q-field>
            <csc-pbx-model-select
                :profiles="profiles"
                :modelImages="modelImages"
                :label="$t('pbxConfig.deviceModel')"
                @opened="modelSelectOpened()"
                @select="selectProfile"
                @reseted="resetProfile"
            />
        </q-field>
        <div
            class="row justify-center form-actions"
        >
            <q-btn
                v-if="!loading"
                flat color="secondary"
                icon="clear"
                @click="cancel()"
            >
                {{ $t('buttons.cancel') }}
            </q-btn>
            <q-btn
                v-if="!loading"
                flat
                color="primary"
                icon="done"
                @click="save()"
                :disabled="$v.data.$invalid || !data.profile_id"
            >
                {{ $t('buttons.save') }}
            </q-btn>
        </div>
        <q-inner-loading
            v-show="loading"
            :visible="loading"
        >
            <q-spinner-mat
                size="60px"
                color="primary"
            />
        </q-inner-loading>
    </div>
</template>

<script>
    import {
        required,
        maxLength
    } from 'vuelidate/lib/validators'
    import { customMacAddress } from '../../../helpers/validation'
    import {
        QCard,
        QCardTitle,
        QCardMain,
        QCardActions,
        QCardSeparator,
        QBtn,
        QInnerLoading,
        QSpinnerMat,
        QField,
        QInput,
        QSelect,
        QIcon,
        QItem,
        QItemMain } from 'quasar-framework'
    import CscPbxModelSelect from './CscPbxModelSelect'

    export default {
        name: 'csc-pbx-device-add-form',
        props: [
            'profiles',
            'modelImages',
            'loading'
        ],
        components: {
            CscPbxModelSelect,
            QCard,
            QCardTitle,
            QCardMain,
            QCardActions,
            QCardSeparator,
            QBtn,
            QInnerLoading,
            QSpinnerMat,
            QField,
            QInput,
            QSelect,
            QIcon,
            QItem,
            QItemMain
        },
        validations: {
            data: {
                station_name: {
                    required,
                    maxLength: maxLength(64)
                },
                identifier: {
                    required,
                    customMacAddress
                }
            }
        },
        data () {
            return {
                formEnabled: false,
                data: this.getDefaults()
            }
        },
        computed: {
            stationNameErrorMessage() {
                if (!this.$v.data.station_name.required) {
                    return this.$t('validationErrors.fieldRequired', {
                        field: this.$t('pbxConfig.deviceStationName')
                    });
                }
                else if (!this.$v.data.station_name.maxLength) {
                    return this.$t('validationErrors.maxLength', {
                        field: this.$t('pbxConfig.deviceStationName'),
                        maxLength: this.$v.data.station_name.$params.maxLength.max
                    });
                }
            },
            identifierErrorMessage() {
                if (!this.$v.data.identifier.required) {
                    return this.$t('validationErrors.fieldRequired', {
                        field: this.$t('pbxConfig.deviceIdentifier')
                    });
                }
                else if (!this.$v.data.identifier.customMacAddress) {
                    return this.$t('validationErrors.macAddress');
                }
            }
        },
        methods: {
            getDefaults() {
                return {
                    station_name: '',
                    identifier: '',
                    profile_id: null,
                    lines: null
                }
            },
            enableForm(){
                this.formEnabled = true;
            },
            disableForm(){
                this.reset();
                this.$emit('cancelForm');
            },
            cancel() {
                this.disableForm();
            },
            save() {
                this.$emit('save', this.data);
            },
            reset() {
                this.data = this.getDefaults();
            },
            modelSelectOpened() {
                this.$emit('modelSelectOpened');
            },
            selectProfile(profile) {
                this.data.profile_id = profile.id;
            },
            resetProfile() {
                this.data.profile_id = null;
            }
        }
    }
</script>

<style lang="stylus" rel="stylesheet/stylus">
    @import '../../../themes/quasar.variables.styl';
    .form-actions
        margin-top 16px
        margin-bottom 8px
</style>
